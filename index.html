<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSM - Dashboard Produ√ß√£o (Vers√£o Est√°vel)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');
        :root { --gsm-blue: #0A1D37; --gsm-accent: #1E3A8A; --success: #10B981; --border: #E2E8F0; }
        * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        @page { size: A4 landscape; margin: 10mm; }
        body { background-color: #F1F5F9; margin: 0; display: flex; font-size: 8.5pt; color: #334155; }
        .sidebar { width: 220px; height: 100vh; background: var(--gsm-blue); padding: 20px; position: fixed; color: white; z-index: 1000; overflow-y: auto; }
        .sidebar h2 { font-size: 11pt; text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .status-badge { font-size: 7pt; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: 600; }
        .main-content { margin-left: 220px; padding: 15px; width: calc(100% - 220px); display: flex; justify-content: center; }
        .container { width: 100%; max-width: 277mm; background: white; padding: 15px; border-radius: 2px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        header { display: grid; grid-template-columns: 160px 1fr 160px; align-items: center; border: 2px solid var(--gsm-blue); margin-bottom: 15px; height: 70px; }
        .logo-area { height: 100%; display: flex; align-items: center; justify-content: center; border-right: 2px solid var(--gsm-blue); cursor: pointer; background: #fff; }
        .logo-area img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .company-info { text-align: center; }
        .company-info h1 { margin: 0; font-size: 14pt; color: var(--gsm-blue); font-weight: 800; text-transform: uppercase; }
        .company-info .subtitle { font-size: 10pt; color: var(--gsm-accent); font-weight: 600; }
        .master-dash { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-group { border: 1px solid var(--border); background: #f8fafc; padding: 10px; border-top: 3px solid var(--gsm-accent); }
        .kpi-group-title { font-size: 7pt; font-weight: 800; color: var(--gsm-blue); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .kpi-row { display: flex; justify-content: space-between; text-align: center; }
        .kpi-label { font-size: 6pt; color: #64748B; font-weight: 700; display: block; }
        .kpi-value { font-size: 11pt; font-weight: 800; color: var(--gsm-blue); }
        .map-container { margin-bottom: 15px; border: 1px solid var(--border); padding: 8px; background: #fff; }
        .map-placeholder { width: 100%; min-height: 220px; background: #f8fafc; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; margin-top: 5px; }
        .map-placeholder img { max-width: 100%; max-height: 400px; object-fit: contain; }
        .block-header { background: var(--gsm-blue); color: white; padding: 6px 15px; display: flex; align-items: center; gap: 20px; margin-top: 12px; }
        .bar-bg { background: rgba(255,255,255,0.2); height: 8px; flex-grow: 1; border-radius: 4px; overflow: hidden; }
        .bar-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.5s; }
        table { width: 100%; border-collapse: collapse; border: 1px solid var(--border); table-layout: fixed; }
        th { background: #F1F5F9; color: var(--gsm-blue); font-size: 7pt; padding: 6px 2px; border: 1px solid var(--border); text-transform: uppercase; }
        td { border: 1px solid var(--border); height: 30px; text-align: center; }
        input { width: 100%; height: 100%; border: none; text-align: center; font-size: 8.5pt; background: transparent; }
        .readonly { background: #F8FAFC; font-weight: 800; color: var(--gsm-accent); }
        .btn { width: 100%; padding: 10px; border: none; color: white; font-weight: 600; cursor: pointer; margin-bottom: 8px; border-radius: 4px; }
        .btn-mini { padding: 3px 10px; font-size: 7pt; background: var(--gsm-blue); color: white; border: none; cursor: pointer; border-radius: 2px; }
        @media print { .sidebar, .no-print, .loop-controls { display: none !important; } .main-content { margin-left: 0; width: 100%; } }
    </style>
</head>
<body>
    <div class="sidebar no-print">
        <h2>GSM SYSTEM</h2>
        <div id="db-status" class="status-badge">Conectando...</div>
        <button class="btn" style="background:var(--success)" onclick="addRowStd('bodyPicada', 'pic')">‚ûï LINHA PICADA</button>
        <button class="btn" style="background:var(--success)" onclick="addRowStd('bodyAquisicao', 'aq')">‚ûï LINHA AQUISI√á√ÉO</button>
        <button class="btn" style="background:var(--gsm-accent)" onclick="addNewLoopBlock()">üí† NOVO LOOP</button>
        <button class="btn" style="background:#0ea5e9" onclick="exportData()">üíæ EXPORTAR JSON</button>
        <button class="btn" style="background:#ef4444" onclick="clearAllData()">üóëÔ∏è RESETAR TUDO</button>
        <button class="btn" style="background:#475569" onclick="window.print()">üñ®Ô∏è PDF</button>
    </div>

    <div class="main-content">
        <div class="container">
            <header>
                <div class="logo-area" onclick="document.getElementById('inLog').click()">
                    <input type="file" id="inLog" style="display:none" onchange="loadFile(event, 'outL', 'txtL')">
                    <img id="outL" style="display:none">
                    <small id="txtL">LOGOTIPO</small>
                </div>
                <div class="company-info">
                    <h1>GSM CONSULTORIA EM GEOCI√äNCIAS</h1>
                    <div class="subtitle">RELAT√ìRIO DE PRODU√á√ÉO DI√ÅRIA</div>
                </div>
                <div style="background:var(--gsm-blue); color:white; padding:10px; font-size:7.5pt; text-align:center;">DOC: PRD-26<br>REV: 38</div>
            </header>

            <div class="master-dash">
                <div class="kpi-group">
                    <span class="kpi-group-title">Resumo Picada</span>
                    <div class="kpi-row">
                        <div><span class="kpi-label">Plan.</span><div class="kpi-value" id="k_p_plan">0</div></div>
                        <div><span class="kpi-label">Exec.</span><div class="kpi-value" id="k_p_exec">0</div></div>
                    </div>
                </div>
                <div class="kpi-group">
                    <span class="kpi-group-title">Resumo Aquisi√ß√£o</span>
                    <div class="kpi-row">
                        <div><span class="kpi-label">Plan.</span><div class="kpi-value" id="k_a_plan">0</div></div>
                        <div><span class="kpi-label">Exec.</span><div class="kpi-value" id="k_a_exec">0</div></div>
                    </div>
                </div>
                <div class="kpi-group">
                    <span class="kpi-group-title">Resumo Loops</span>
                    <div class="kpi-row">
                        <div><span class="kpi-label">Plan.</span><div class="kpi-value" id="k_l_plan">0</div></div>
                        <div><span class="kpi-label">Exec.</span><div class="kpi-value" id="k_l_exec">0</div></div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div class="map-placeholder" onclick="document.getElementById('inMap').click()">
                    <input type="file" id="inMap" style="display:none" onchange="loadFile(event, 'outMap', 'mapTxt')">
                    <img id="outMap" style="display:none">
                    <div id="mapTxt">Clique para carregar o mapa</div>
                </div>
                <input type="date" id="mapDate" oninput="saveToFirebase()" style="width:200px; margin-top:5px; border:1px solid #eee">
                <input type="text" id="mapDesc" placeholder="Descri√ß√£o do progresso..." oninput="saveToFirebase()" style="width:100%; border-bottom:1px solid #eee; text-align:left">
            </div>

            <div class="block-header"><span>PICADA</span><div class="bar-bg"><div class="bar-fill" id="bar_pic"></div></div><span id="pct_pic">0%</span></div>
            <table><thead><tr><th>Data</th><th>Alvo</th><th>Linha</th><th>De</th><th>At√©</th><th>Plan.</th><th>Exec.</th><th>%</th><th>OBS</th></tr></thead><tbody id="bodyPicada"></tbody></table>

            <div class="block-header"><span>AQUISI√á√ÉO</span><div class="bar-bg"><div class="bar-fill" id="bar_aq"></div></div><span id="pct_aq">0%</span></div>
            <table><thead><tr><th>Data</th><th>Alvo</th><th>Linha</th><th>De</th><th>At√©</th><th>Plan.</th><th>Exec.</th><th>%</th><th>OBS</th></tr></thead><tbody id="bodyAquisicao"></tbody></table>

            <div id="loopsWrapper"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9voukHIX_Da9A-ZRH994mp1ZFiTxoC8M",
            authDomain: "sistemagsm.firebaseapp.com",
            databaseURL: "https://sistemagsm-default-rtdb.firebaseio.com",
            projectId: "sistemagsm",
            storageBucket: "sistemagsm.firebasestorage.app",
            messagingSenderId: "27185156208",
            appId: "1:27185156208:web:ab96087d7d756e5cdfa4b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let loopCounter = 0;

        // --- SALVAMENTO ---
        function saveToFirebase() {
            try {
                const data = {
                    pic: getTableData('bodyPicada'),
                    aq: getTableData('bodyAquisicao'),
                    loops: Array.from(document.querySelectorAll('[id^="group_loop_"]')).map(el => {
                        const id = el.id.replace('group_loop_', '');
                        return {
                            id: id,
                            p: document.getElementById(`p_loop_${id}`)?.value || 0,
                            rows: getTableData(`tbody_loop_${id}`)
                        };
                    }),
                    logo: document.getElementById('outL').src.startsWith('data') ? document.getElementById('outL').src : "",
                    map: document.getElementById('outMap').src.startsWith('data') ? document.getElementById('outMap').src : "",
                    mapDate: document.getElementById('mapDate').value,
                    mapDesc: document.getElementById('mapDesc').value
                };

                db.ref('producao_atual').set(data).then(() => {
                    document.getElementById('db-status').innerText = "‚úÖ Sincronizado";
                    document.getElementById('db-status').style.color = "#10B981";
                });
            } catch (e) { console.error("Erro ao salvar:", e); }
        }

        function getTableData(id) {
            const b = document.getElementById(id); if(!b) return [];
            return Array.from(b.rows).map(r => Array.from(r.querySelectorAll('input')).map(i => i.value));
        }

        // --- GEST√ÉO DE LINHAS ---
        function addRowStd(tbodyId, prefix, saved = null) {
            const tbody = document.getElementById(tbodyId);
            const row = tbody.insertRow();
            const isFirst = tbody.rows.length === 1;
            row.innerHTML = `
                <td><input type="date" value="${saved?.[0] || ''}" oninput="saveToFirebase()"></td>
                <td><input type="text" value="${saved?.[1] || ''}" oninput="saveToFirebase()"></td>
                <td><input type="text" value="${saved?.[2] || ''}" oninput="saveToFirebase()"></td>
                <td><input type="number" class="${prefix}-de" oninput="syncAll()" value="${saved?.[3] || ''}"></td>
                <td><input type="number" class="${prefix}-a" oninput="syncAll()" value="${saved?.[4] || ''}"></td>
                ${isFirst ? `<td class="readonly" rowspan="1"><input type="number" id="${prefix}-plan" value="${saved?.[5] || '4000'}" oninput="syncAll()"></td><td class="readonly" id="${prefix}-exec">0</td><td class="readonly" id="${prefix}-pct">0%</td>` : ''}
                <td><input type="text" value="${saved?.[isFirst?8:5] || ''}" oninput="saveToFirebase()"></td>`;
            if (isFirst) updateSpans(tbodyId);
            if(!saved) syncAll();
        }

        function addNewLoopBlock(forcedId = null) {
            const id = forcedId || ++loopCounter;
            const wrap = document.createElement('div');
            wrap.id = `group_loop_${id}`;
            wrap.innerHTML = `
                <div class="block-header">LOOP L${id} <div class="bar-bg"><div class="bar-fill" id="bar_loop_${id}"></div></div> <span id="pct_txt_loop_${id}">0%</span></div>
                <table>
                    <tbody id="tbody_loop_${id}">
                        <tr style="background:#eee"><th>Data</th><th>Alvo</th><th>L</th><th>N</th><th>S</th><th>E</th><th>W</th><th>Plan</th><th>Exec</th><th>%</th><th>OBS</th></tr>
                        <tr>
                            <td><input type="date" oninput="saveToFirebase()"></td>
                            <td><input type="text" oninput="saveToFirebase()"></td>
                            <td><input type="text" value="L${id}" readonly></td>
                            <td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')"></td>
                            <td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')"></td>
                            <td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')"></td>
                            <td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')"></td>
                            <td class="readonly"><input type="number" id="p_loop_${id}" value="4000" oninput="sumLoop('${id}')"></td>
                            <td class="readonly loop-exec-val-internal" id="ex_loop_${id}">0</td>
                            <td class="readonly" id="pc_loop_${id}">0%</td>
                            <td><input type="text" oninput="saveToFirebase()"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="no-print" style="text-align:right; padding:5px"><button class="btn-mini" onclick="addRowLoop('${id}')">‚ûï LINHA</button></div>`;
            document.getElementById('loopsWrapper').appendChild(wrap);
            if(!forcedId) saveToFirebase();
        }

        function addRowLoop(id, saved = null) {
            const tbody = document.getElementById(`tbody_loop_${id}`);
            const row = tbody.insertRow();
            row.innerHTML = `<td><input type="date" value="${saved?.[0]||''}" oninput="saveToFirebase()"></td><td><input type="text" value="${saved?.[1]||''}" oninput="saveToFirebase()"></td><td></td><td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')" value="${saved?.[3]||''}"></td><td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')" value="${saved?.[4]||''}"></td><td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')" value="${saved?.[5]||''}"></td><td><input type="number" class="in-loop-${id}" oninput="sumLoop('${id}')" value="${saved?.[6]||''}"></td><td colspan="3"></td><td><input type="text" oninput="saveToFirebase()" value="${saved?.[10]||''}"></td>`;
            updateLoopSpans(id);
        }

        // --- C√ÅLCULOS ---
        function syncAll() {
            ['pic', 'aq'].forEach(calcStd);
            updateMaster();
            saveToFirebase();
        }

        function calcStd(p) {
            let t = 0;
            const des = document.querySelectorAll(`.${p}-de`), as = document.querySelectorAll(`.${p}-a`);
            des.forEach((el, i) => t += Math.abs((parseFloat(as[i].value)||0) - (parseFloat(el.value)||0)));
            const plan = parseFloat(document.getElementById(`${p}-plan`)?.value)||1;
            const pct = Math.round((t/plan)*100);
            document.getElementById(`${p}-exec`).innerText = t;
            document.getElementById(`${p}-pct`).innerText = pct+"%";
            document.getElementById(`pct_${p}`).innerText = pct+"%";
            document.getElementById(`bar_${p}`).style.width = Math.min(pct,100)+"%";
        }

        function sumLoop(id) {
            let t = 0; document.querySelectorAll(`.in-loop-${id}`).forEach(i => t += (parseFloat(i.value)||0));
            const p = parseFloat(document.getElementById(`p_loop_${id}`).value)||1;
            const pct = Math.round((t/p)*100);
            document.getElementById(`ex_loop_${id}`).innerText = t;
            document.getElementById(`pc_loop_${id}`).innerText = pct+"%";
            document.getElementById(`pct_txt_loop_${id}`).innerText = pct+"%";
            document.getElementById(`bar_loop_${id}`).style.width = Math.min(pct,100)+"%";
            updateMaster();
            saveToFirebase();
        }

        function updateMaster() {
            document.getElementById('k_p_plan').innerText = document.getElementById('pic-plan')?.value || 0;
            document.getElementById('k_p_exec').innerText = document.getElementById('pic-exec')?.innerText || 0;
            document.getElementById('k_a_plan').innerText = document.getElementById('aq-plan')?.value || 0;
            document.getElementById('k_a_exec').innerText = document.getElementById('aq-exec')?.innerText || 0;
            let lp=0, le=0;
            document.querySelectorAll('[id^="p_loop_"]').forEach(i => lp += parseFloat(i.value)||0);
            document.querySelectorAll('.loop-exec-val-internal').forEach(i => le += parseFloat(i.innerText)||0);
            document.getElementById('k_l_plan').innerText = lp;
            document.getElementById('k_l_exec').innerText = le;
        }

        function updateSpans(id) { 
            const rows = document.getElementById(id).rows;
            if(rows.length>0) Array.from(rows[0].querySelectorAll('.readonly')).forEach(c => c.rowSpan = rows.length);
        }
        function updateLoopSpans(id) {
            const rows = document.getElementById(`tbody_loop_${id}`).rows;
            if(rows.length>1) Array.from(rows[1].querySelectorAll('.readonly')).forEach(c => c.rowSpan = rows.length - 1);
        }

        // --- IMAGENS ---
        function loadFile(e, imgId, txtId) {
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.getElementById(imgId);
                img.src = reader.result;
                img.style.display = 'block';
                document.getElementById(txtId).style.display = 'none';
                saveToFirebase();
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        // --- LOAD INICIAL ---
        window.onload = () => {
            db.ref('producao_atual').once('value').then(s => {
                const d = s.val();
                if(!d) { addRowStd('bodyPicada','pic'); addRowStd('bodyAquisicao','aq'); return; }
                
                if(d.pic) d.pic.forEach(r => addRowStd('bodyPicada','pic', r));
                if(d.aq) d.aq.forEach(r => addRowStd('bodyAquisicao','aq', r));
                
                if(d.loops) {
                    d.loops.forEach(l => {
                        addNewLoopBlock(l.id);
                        document.getElementById(`p_loop_${l.id}`).value = l.p;
                        const tbody = document.getElementById(`tbody_loop_${l.id}`);
                        // Preenche a primeira linha j√° existente
                        const firstRowInputs = tbody.rows[1].querySelectorAll('input');
                        l.rows[0].forEach((val, idx) => { if(firstRowInputs[idx]) firstRowInputs[idx].value = val; });
                        // Adiciona as demais
                        l.rows.slice(1).forEach(rd => addRowLoop(l.id, rd));
                        sumLoop(l.id);
                    });
                    loopCounter = Math.max(...d.loops.map(l => parseInt(l.id)), 0);
                }

                if(d.logo) { 
                    document.getElementById('outL').src = d.logo; 
                    document.getElementById('outL').style.display = 'block';
                    document.getElementById('txtL').style.display = 'none';
                }
                if(d.map) { 
                    document.getElementById('outMap').src = d.map; 
                    document.getElementById('outMap').style.display = 'block';
                    document.getElementById('mapTxt').style.display = 'none';
                }
                document.getElementById('mapDate').value = d.mapDate || "";
                document.getElementById('mapDesc').value = d.mapDesc || "";
                syncAll();
                document.getElementById('db-status').innerText = "‚úÖ Conectado";
            });
        };

        function clearAllData() { if(confirm("Limpar tudo?")) db.ref('producao_atual').remove().then(() => location.reload()); }
    </script>
</body>
</html>